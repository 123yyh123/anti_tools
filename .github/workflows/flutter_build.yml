# GitHub Actions å·¥ä½œæµé…ç½® - Flutter Android åº”ç”¨æž„å»º
# ç®€åŒ–ç‰ˆæœ¬ï¼šåªåœ¨æŽ¨é€æ ‡ç­¾æ—¶æž„å»ºå¹¶å‘å¸ƒåˆ° Release

name: Build Android APK

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æž„å»ºç±»åž‹'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug
  
  # åªåœ¨æŽ¨é€æ ‡ç­¾æ—¶è§¦å‘æž„å»ºå’Œå‘å¸ƒ
  push:
    tags:
      - 'v*'  # æŽ¨é€ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰

env:
  FLUTTER_VERSION: '3.38.5'
  FLUTTER_CHANNEL: 'master'
  JAVA_VERSION: '17'

jobs:
  build:
    name: Build & Release
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æŽˆäºˆåˆ›å»º Release çš„æƒé™
    
    steps:
      # æ¸…ç†ç£ç›˜ç©ºé—´ - å¿…é¡»æœ€å…ˆæ‰§è¡Œ
      - name: Free disk space
        run: |
          echo "ðŸ§¹ æ¸…ç†ç£ç›˜ç©ºé—´..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android/sdk/ndk/2[0-6].*
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          docker system prune -af 2>/dev/null || true
          echo "âœ… ç£ç›˜æ¸…ç†å®Œæˆ"
          df -h /
      
      # æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # è®¾ç½® Java çŽ¯å¢ƒ
      - name: Set up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
      
      # è®¾ç½® Flutter çŽ¯å¢ƒï¼ˆå¸¦ç¼“å­˜ï¼‰
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true
      
      # ç¼“å­˜ pub ä¾èµ–
      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-
      
      # ç¼“å­˜ Gradleï¼ˆæž„å»ºç¼“å­˜ + wrapperï¼‰
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-
      # èŽ·å–ä¾èµ–
      - name: Get Flutter dependencies
        run: flutter pub get
      
      # æž„å»º Android APKï¼ˆä¼˜åŒ–å‚æ•°ï¼‰
      - name: Build APK
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
          echo "ðŸ”¨ æž„å»ºç±»åž‹: $BUILD_TYPE"
          
          # è®¾ç½® Gradle ä¼˜åŒ–å‚æ•°
          export GRADLE_OPTS="-Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.caching=true -Dorg.gradle.jvmargs=-Xmx4g"
          
          if [ "$BUILD_TYPE" = "release" ]; then
            flutter build apk --release --no-tree-shake-icons
          else
            flutter build apk --debug
          fi
      
      # èŽ·å–åº”ç”¨ç‰ˆæœ¬ä¿¡æ¯
      - name: Get app version
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | head -1 | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ åº”ç”¨ç‰ˆæœ¬: $VERSION"
      
      # é‡å‘½å APK æ–‡ä»¶ï¼ˆæ·»åŠ ç‰ˆæœ¬å·ï¼‰
      - name: Rename APK
        run: |
          cd build/app/outputs/flutter-apk
          for f in *.apk; do
            mv "$f" "AntiTools-${{ steps.version.outputs.version }}-${f}"
          done
          ls -lh *.apk
      
      # åˆ›å»º Release å¹¶ä¸Šä¼  APKï¼ˆä»…åœ¨æ ‡ç­¾æŽ¨é€æ—¶ï¼‰
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: build/app/outputs/flutter-apk/*.apk
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # æž„å»ºä¿¡æ¯æ‘˜è¦
      - name: Build Summary
        run: |
          echo "## ðŸŽ‰ æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| åº”ç”¨ç‰ˆæœ¬ | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºç±»åž‹ | ${{ github.event.inputs.build_type || 'release' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Flutter ç‰ˆæœ¬ | ${{ env.FLUTTER_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### APK æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          ls -lh build/app/outputs/flutter-apk/*.apk | awk '{print "- " $NF " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY

